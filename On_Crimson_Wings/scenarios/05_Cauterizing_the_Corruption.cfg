#textdomain wesnoth-On_Crimson_Wings

## Needs: improved dialogue; balancing (esp. easy/hard); improved music selection
##        Blighted forest terrain would be good here; tropical forest image not ideal for vines, but is it worth the effort?
##        Lord of Decay image is a placeholder, lacks melee, defensive, death animations
##        Organize events -- right now finding a particular one is a bit of a hassle because there are so (&(&* many
##        Is there too much talking?  Or is all the talking too early?  Consider events for later turns (Eódia notes gold shift?)
##        Map graphics could be improved in general - add scenery & items

## Name notes: hero = Feralon; rival = Varnir; advisor = Galgor; friend = Karath Kor; dead king = Regar; sister = Demla Ka
##             shamans = Laviniel and Celondë; elf queen = Eódia

[scenario]
    id=05_Cauterizing_the_Corruption
    name=_ "Cauterizing the Corruption"
    next_scenario=05x_Forest_Interlude

    map_data="{~campaigns/On_Crimson_Wings/maps/05_Cauterizing_the_Corruption.map}"

    {TURNS 46 46 40}  ## always end after first watch

    {SCENARIO_MUSIC knalgan_theme.ogg}

    victory_when_enemies_defeated=no

    {MORNING}
    {AFTERNOON}
    {DUSK}
    {FIRST_WATCH}
    {SECOND_WATCH}
    {DAWN}

    [side]
        {FERALON_SIDE}
        {GOLD 320 280 240}
        {INCOME 5 3 0}
        fog=yes
        share_view=yes
    [/side]

    [side]
        side=2
        controller=ai
        team_name=1
        user_team_name= _ "Elves"

        type=Elvish Shyde
        description=Eódia
        user_description=_"Eódia"
        gender=female
        canrecruit=yes
        random_traits=no
        [modifications]
            {TRAIT_INTELLIGENT}
            {TRAIT_DEXTROUS}
        [/modifications]

        recruit=Elvish Archer, Elvish Fighter, Elvish Shaman
        {GOLD 120 100 80}
        {INCOME 5 3 0}
        fog=yes
        share_view=yes

        [ai]
            recruitment_pattern=healer,archer,fighter,healer
            caution=3.5  ## Of course, they'll still merrily stand outside the forest and get slaughtered
            aggression=-0.4
            [leader_goal]
                x,y=10,33  ## Attempt to give Eódia a fighting chance of not running off to die
            [/leader_goal]
        [/ai]
    [/side]

#define UNDEAD_TARGETS
    [target]
        description=Eódia
        value=20
    [/target]
    [target]
        side=1
        value=10
    [/target]
    [protect_unit]
        description=Leódir
        value=20
        radius=6
    [/protect_unit]
#enddef

    [side]
        side=3
        controller=ai
        team_name=undead
        user_team_name=_ "Undead"

        type=Necrophage
        canrecruit=yes

#ifdef EASY
        recruit=Walking Corpse
#else
        recruit=Walking Corpse,Soulless
#endif

        {GOLD 21 35 49}
        {INCOME 0 1 5}

        [ai]
            aggression=1
            caution=0
            {NO_SCOUTS}
            {UNDEAD_TARGETS}
        [/ai]

        {GETS_VILLAGE 4 2}
        {GETS_VILLAGE 15 7}
        {GETS_VILLAGE 4 16}
        {GETS_VILLAGE 12 14}
    [/side]

    [side]
        side=4
        controller=ai
        team_name=undead
        user_team_name=_ "Undead"

        type=Death Knight
        description=Undead Captain
        user_description=_ "Undead Captain"
        gender=male
        canrecruit=yes
#ifdef EASY
        recruit=Skeleton,Skeleton Archer,Ghost
#else
        recruit=Skeleton,Skeleton Archer,Bone Shooter,Ghost
#endif
        {GOLD 30 45 60}
        {INCOME 0 5 10}

        [ai]
            {NO_SCOUTS}
            {UNDEAD_TARGETS}
            caution=0
        [/ai]

        {GETS_VILLAGE 28 30}
        {GETS_VILLAGE 29 35}
        {GETS_VILLAGE 31 26}
        {GETS_VILLAGE 44 31}
        {GETS_VILLAGE 38 39}
        {GETS_VILLAGE 34 19}
        {GETS_VILLAGE 42 21}
    [/side]

    [side]
        side=5
        controller=ai
        team_name=undead
        user_team_name=_ "Corrupted Woses"

        type=Lord of Decay
        description=Leódir
        user_description=_ "Leódir"
        gender=male
        canrecruit=yes

#ifdef EASY
        recruit=Corrupted Wose, Ghost
#else
        recruit=Corrupted Wose, Corrupted Elder Wose, Ghost, Wraith
#endif

        {GOLD 32 42 63}
        {INCOME 0 5 10}

        [ai]
            {NO_SCOUTS}
            passive_leader=yes
            caution=0.1
            {UNDEAD_TARGETS}
        [/ai]

        {GETS_VILLAGE 23 22}
        {GETS_VILLAGE 19 16}
        {GETS_VILLAGE 27 16}
        {GETS_VILLAGE 24 10}
        {GETS_VILLAGE 24 4}
        {GETS_VILLAGE 37 4}
        {GETS_VILLAGE 44 4}
        {GETS_VILLAGE 41 13}
    [/side]

    [side]
        side=6
        controller=ai
        team_name=undead
        user_team_name=_ "Undead"

        no_leader=yes

#ifdef EASY
        recruit=Revenant,Bone Shooter
#else
        recruit=Revenant,Bone Shooter,Shadow,Wraith
#endif
        {NO_GOLD_SIDE}

        [ai]
            {NO_SCOUTS}
            village_value=0.2
            {UNDEAD_TARGETS}
        [/ai]
    [/side]

    #undef UNDEAD_TARGETS

    [side]
        side=7
        controller=ai
        team_name=1
        user_team_name=" "

        no_leader=yes
        recruit=Wose
        {NO_GOLD_SIDE}
        fog=yes
        share_view=yes

        [ai]
            village_value=0
        [/ai]
    [/side]

    ##|| Events ||##

    [event]
        name=prestart

        {PLACE_IMAGE scenery/village-human-burned1.png 6 6}
        {PLACE_IMAGE scenery/village-human-burned1.png 34 10}
        {PLACE_IMAGE scenery/village-human-burned1.png 20 26}
        {PLACE_IMAGE scenery/village-human-burned2.png 28 7}
        {PLACE_IMAGE scenery/village-human-burned2.png 37 31}
        {PLACE_IMAGE scenery/village-human-burned2.png 3 19}
        {PLACE_IMAGE scenery/village-human-burned2.png 23 34}
        {PLACE_IMAGE scenery/village-human-burned3.png 49 21}
        {PLACE_IMAGE scenery/village-human-burned3.png 10 20}
        {PLACE_IMAGE scenery/village-human-burned4.png 11 11}
        {PLACE_IMAGE scenery/village-human-burned4.png 41 33}
        {PLACE_IMAGE scenery/village-human-burned4.png 23 40}
        
        {VARIABLE eodia_alive yes}  ## Needed for scenario 5x
        {VARIABLE mondir_alive yes}
        {VARIABLE wose_leader_alive no}
        {VARIABLE leodir_sighted no}
        {VARIABLE wose_side 5}
        {DIFFICULTY_VARIABLE side3_boost 28 35 49} ## Bonus gold received each First Watch
        {DIFFICULTY_VARIABLE side4_boost 60 80 100}
        {DIFFICULTY_VARIABLE side5_boost 84 105 147}

        [unit]
            type=Elvish Hero
            side=2
            description=Móndir
            user_description=_ "Móndir"
            gender=male
            unrenamable=yes
            hitpoints=44
            x,y=10,31
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]

#define ELF_GUARDIAN TYPE X Y UPKEEP
    [unit]
        side=2
        type={TYPE}
        x,y={X},{Y}
        generate_description=yes
        random_traits=yes
        random_gender=yes
        ai_special=guardian
        upkeep={UPKEEP}
    [/unit]
#enddef

#define WOUNDED_ELF TYPE X Y
    [unit]
        side=2
        type={TYPE}
        x,y={X},{Y}
        generate_description=yes
        random_traits=yes
        random_gender=yes
    [/unit]

    [store_unit]
        [filter]
            x,y={X},{Y}
        [/filter]
        variable=elf_store
        kill=yes
    [/store_unit]

    {RANDOM 1..10}
    {VARIABLE elf_store.hitpoints $random}

    [unstore_unit]
        variable=elf_store
    [/unstore_unit]

    {CLEAR_VARIABLE elf_store}
#enddef

        {ELF_GUARDIAN (Elvish Druid) 9 33 loyal}
#ifndef HARD
        {ELF_GUARDIAN (Elvish Druid) 11 33 loyal}
#endif
        {ELF_GUARDIAN (Elvish Fighter) 5 25 full}
        {WOUNDED_ELF (Elvish Archer) 8 33}
        {ELF_GUARDIAN (Elvish Archer) 13 26 full}
        {ELF_GUARDIAN (Elvish Fighter) 15 27 full}
        {ELF_GUARDIAN (Elvish Fighter) 18 32 full}
        {WOUNDED_ELF (Elvish Archer) 12 33}
        {ELF_GUARDIAN (Elvish Archer) 18 37 full}

        #undef ELF_GUARDIAN
        #undef WOUNDED_ELF

        ## The undead army is poised to attack

#define CORPSE_ARMY TYPE X Y
    {RANDOM none,none,none,wose,gryphon}
    [if]
        {VAR_EQUALS random none}
        [then]
            [unit]
                type={TYPE}
                side=3
                x,y={X},{Y}
            [/unit]
        [/then]
        [else]
            [unit]
                type={TYPE}
                variation=$random
                side=3
                x,y={X},{Y}
            [/unit]
        [/else]
    [/if]
#enddef

        {CORPSE_ARMY (Walking Corpse) 8 11}
        {CORPSE_ARMY (Walking Corpse) 8 12}
        {CORPSE_ARMY (Walking Corpse) 9 11}
        {CORPSE_ARMY (Walking Corpse) 9 13}
        {CORPSE_ARMY (Walking Corpse) 10 11}
        {CORPSE_ARMY (Walking Corpse) 10 12}
        {CORPSE_ARMY (Walking Corpse) 5 13}
        {CORPSE_ARMY (Walking Corpse) 7 13}
        {CORPSE_ARMY (Walking Corpse) 11 13}
        {CORPSE_ARMY (Walking Corpse) 13 13}
        {CORPSE_ARMY (Walking Corpse) 8 10}
        {CORPSE_ARMY (Walking Corpse) 10 10}
        {CORPSE_ARMY (Walking Corpse) 25 19}
        {CORPSE_ARMY (Walking Corpse) 25 20}
        {CORPSE_ARMY (Walking Corpse) 26 18}
        {CORPSE_ARMY (Walking Corpse) 26 20}
        {CORPSE_ARMY (Walking Corpse) 27 19}
        {CORPSE_ARMY (Walking Corpse) 27 20}
        {CORPSE_ARMY (Walking Corpse) 17 15}
        {CORPSE_ARMY (Walking Corpse) 18 16}

        {CORPSE_ARMY Soulless 9 12}
        {CORPSE_ARMY Soulless 26 19}
#ifndef EASY
        {CORPSE_ARMY Soulless 6 12}
        {CORPSE_ARMY Soulless 12 13}
        {CORPSE_ARMY (Walking Corpse) 8 13}
        {CORPSE_ARMY (Walking Corpse) 10 13}
#endif
#ifdef HARD
        {CORPSE_ARMY Soulless 28 18}
        {CORPSE_ARMY Soulless 9 10}
#endif

        #undef CORPSE_ARMY

        {GENERIC_UNIT 4 Skeleton 34 32}
        {GENERIC_UNIT 4 Skeleton 34 34}
        {GENERIC_UNIT 4 Skeleton 31 40}
        {GENERIC_UNIT 4 Skeleton 33 31}
        {GENERIC_UNIT 4 Skeleton 30 21}
        {GENERIC_UNIT 4 (Skeleton Archer) 35 32}
        {GENERIC_UNIT 4 (Skeleton Archer) 35 34}
        {GENERIC_UNIT 4 (Skeleton Archer) 32 40}
        {GENERIC_UNIT 4 (Skeleton Archer) 34 31}
        {GENERIC_UNIT 4 (Skeleton Archer) 31 21}
        {GENERIC_UNIT 4 Ghost 39 33}
        {GENERIC_UNIT 4 Ghost 36 24}
#ifndef EASY
        {GENERIC_UNIT 4 Skeleton 24 20}
        {GENERIC_UNIT 4 Skeleton 25 21}
        {GENERIC_UNIT 4 Skeleton 34 33}
        {GENERIC_UNIT 4 (Bone Shooter) 35 33}
#endif
#ifdef HARD
        {GENERIC_UNIT 4 Skeleton 31 22}
        {GENERIC_UNIT 4 Skeleton 33 35}
        {GENERIC_UNIT 4 (Skeleton Archer) 32 21}
        {GENERIC_UNIT 4 (Bone Shooter) 34 35}
#endif

#ifdef EASY
        {GUARDIAN_WOSE (Corrupted Elder Wose) 28 9}
        {GUARDIAN_WOSE (Corrupted Elder Wose) 30 11}
#else
        {GUARDIAN_WOSE (Corrupted Ancient Wose) 28 9}
        {GUARDIAN_WOSE (Corrupted Ancient Wose) 30 11}
#endif
        {GUARDIAN_WOSE (Corrupted Elder Wose) 39 39}

        {MOBILE_WOSE (Corrupted Wose) 28 20}
        {MOBILE_WOSE (Corrupted Wose) 24 18}
        {MOBILE_WOSE (Corrupted Wose) 28 23}
        {MOBILE_WOSE (Corrupted Wose) 18 13}
#ifndef EASY
        {MOBILE_WOSE (Corrupted Wose) 22 14}
        {MOBILE_WOSE (Corrupted Elder Wose) 29 17}
#endif
#ifdef HARD
        {MOBILE_WOSE (Corrupted Elder Wose) 28 15}
#endif

        {GENERIC_UNIT 5 Ghost 27 14}
        {GENERIC_UNIT 5 Ghost 34 20}
        {GENERIC_UNIT 5 Ghost 17 9}
#ifndef EASY
        {GENERIC_UNIT 5 Ghost 26 13}
        {GENERIC_UNIT 5 Wraith 30 10}
#endif
#ifdef HARD
        {GENERIC_UNIT 5 Wraith 31 11}
#endif

        {SCATTER_UNITS 12 (Walking Corpse) 4 (  ## Scatter some guardian elf corpses around the further reaches of the map
        x=1-50
        y=0-40
        [not]
            x=0-33
            y=9-40
        [/not]

        [not]  ## Don't put them on the lich's castle area.  In one playtest, a walking corpse was sitting on the lich's keep.  She was not amused.
            x=44,45,46,47,48
            y=16-18,16-19,15-19,16-19,16-18
        [/not]

        [not]
            [filter]
            [/filter]
        [/not]

        [not]
            [filter_adjacent_location]
                [filter]
                [/filter]
            [/filter_adjacent_location]
        [/not]
        ) (
        side=3
        ai_special=guardian
        )}

        {RECALL_UNIT Laviniel}
        {RECALL_UNIT Celondë}
        {UNMAKE_HERO Laviniel}
        {UNMAKE_HERO Celondë}
    [/event]

    [event]
        name=start
        {MOVE_UNIT description=Laviniel 9 35}
        {MOVE_UNIT description=Celondë 11 35}
        [if]
            {HAVE Laviniel}
            {HAVE Celondë}
            [then]
                {SPEAK Eódia (_ "Laviniel!  Celondë!  I had all but given up hope.  How have you come to be here, in such strange company?")}
                {SPEAK Laviniel (_ "We had given up hope as well...")}
                {SPEAK Celondë (_ "Speak for yourself.")}
                {SPEAK Laviniel (_ "But these drakes fought off the undead and woses and escorted us across the southern woods.")}
            [/then]
            [else]
                [if]
                    {HAVE Laviniel}
                    [then]
                        {SPEAK Eódia (_ "Laviniel!  I had all but given up hope.  Why are you in such strange company?  Where is Celondë?")}
                        {SPEAK Laviniel (_ "We had given up hope as well, when these drakes came to our rescue.  But Celondë... she didn't...")}
                        {SPEAK Móndir (_ "I am sorry for your loss, Laviniel.")}
                        {SPEAK Laviniel (_ "Mondir... thank you... I...")}
                    [/then]
                    [else]  ## Must have Celondë, then
                        {SPEAK Eódia (_ "Celondë!  I had all but given up hope.  Why are you in such strange company?  Where is Laviniel?")}
                        {SPEAK Celondë (_ "These drakes agreed to protect us and fought bravely against the undead and woses.  But Laviniel... they couldn't...")}
                        {SPEAK Móndir (_ "Alas.  I will miss her.")}
                    [/else]
                [/if]
            [/else]
        [/if]

        {SPEAK Eódia (_ "I would speak with your drake 'saviors.'  Drake lord, please approach.")}

        {MOVE_UNIT description=Feralon 13 35}
        [recall]
            description=Jula
            x,y=14,35  ## Put the merman in the water
        [/recall]
        {RECALL_LOYAL_UNITS}
        {RECALL_UNIT Torr}

        {SPEAK Feralon (_ "I am Feralon, King of the Crimsonwing Drakes.")}
        {SPEAK Eódia (_ "And I, Eódia, Lady of the Silver Wood.  What are your intentions in our forest?")}
        {SPEAK Feralon (_ "Our home was attacked by an army of undead.  We have come seeking vengeance upon them.")}
        {SPEAK Eódia (_ "Then we have common cause.  We believed we had the undead contained after many of them left to march south.  But then a foul corruption began spreading through the forest, turning the woses against us.")}
        {SPEAK Varnir (_ "We observed the woses and the undead fighting against each other.")}
        {SPEAK Eódia (_ "That has not been the case here.  Together, they have taken and defiled our fortresses, leveled and flooded the surrounding land.  For several days we have been besieged in this citadel.")}
        {SPEAK Móndir (_ "Many brave elves have fallen.  The last of our scouts reported a great host of undead in the fog.  I fear this night will be our last.")}
        {SPEAK Feralon (_ "As you say, we have a common cause.  My warriors will aid you in destroying these undead.")}
        {SPEAK Eódia (_ "I thank you.  We gladly accept your aid.  Our villagers will supply you with anything they can.  Prepare yourselves for the coming darkness.")}

        [if]
            {HAVE Laviniel}
            {HAVE Celondë}
            [then]
                {SPEAK Eódia (_ "Laviniel and Celondë, aid the drakes.  Feralon, I task you with their continued protection.")}
            [/then]
            [else]
                [if]
                    {HAVE Laviniel}
                    [then]
                        {SPEAK Eódia (_ "Laviniel, aid the drakes.  Feralon, I task you with her continued protection.")}
                    [/then]
                    [else]  ## Must have Celondë, then
                        {SPEAK Eódia (_ "Celondë, aid the drakes.  Feralon, I task you with her continued protection.")}
                    [/else]
                [/if]
            [/else]
        [/if]

        [objectives]
            side=1
            {VICTORY_CONDITION (_ "Defend the elven citadel and survive the night")}
            {DONT_LOSE_HEROES}
        [/objectives]
    [/event]

    {INTERACTIONS_1}

    {STARTING_VILLAGES 2 11}
    {RECRUIT_UNIT_VARIATIONS 3 (Walking Corpse) none,none,none,wose,gryphon}
    {RECRUIT_UNIT_VARIATIONS 3 Soulless none,none,none,wose,gryphon}

#ifdef NORMAL
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Soulless 4}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Bone Shooter" 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Corrupted Elder Wose" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Ghost 4}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Wraith 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 Shadow 2}
#endif
#ifdef HARD
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Soulless 8}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Bone Shooter" 3}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Corrupted Elder Wose" 4}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Wraith 3}
#endif

    [event]
        name=new turn
        first_time_only=no

        {VARIABLE turn_temp $turn_number}
        {VARIABLE_OP turn_temp modulo 6}

        [if]
            {VAR_EQUALS turn_temp 4}  ## In other words, it's first watch
            [not]
                {HAVE Mal-Taryn}  ## Once the lich is revealed, she stops channeling gold to her servitors
            [/not]
            [then]
                {GIVE_GOLD 3 $side3_boost}
                {GIVE_GOLD 4 $side4_boost}
                {GIVE_GOLD 5 $side5_boost}
            [/then]
        [/if]
    [/event]

    [event]
        name=turn 3
        {SPEAK Eódia (_ "Darkness comes!  Elves and drakes, prepare yourselves!")}
        {SPEAK (Demla Ka) (_ "I don't understand.  You trust us to defend your home, after our people have raided yours again and again?")}
        {SPEAK Feralon (_ "Now may not be the best time to raise that question, brood-sister.")}
        {SPEAK Eódia (_ "Sister?  I do not believe I have seen a female drake before.  I had the impression they were not thinking beings.")}
        {SPEAK (Demla Ka) (_ "Many male drakes are pleased to think so, but the females of my acquaintance would disagree.  Few of us travel beyond our homeland, and the untrained eye cannot tell us from males in any case.")}
        {SPEAK Eódia (_ "To answer your question, I have seen many generations of Crimsonwing Drakes.  With some, we have fought.  With others, we have peacefully traded.  I will judge you by your actions now.")}
        {SPEAK Varnir (_ "Besides, Demla, what choice do they have?")}
    [/event]

    [event]
        name=turn 5
        [if]
            {HAVE Eódia}
            [then]
                {SPEAK Eódia (_ "I can feel the dark energies in this forest growing stronger.  With every stroke of midnight, our enemies grow in strength.")}
                {CHECK_NEARBY Eódia Varnir 8}
                [if]
                    {VAR_EQUALS nearby yes}
                    [then]
                        {SPEAK Varnir (_ "Delightful.")}
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
        name=turn 7
        [if]
            {VAR_EQUALS leodir_sighted no}
            [then]
                {SPEAK Varnir (_ "I doubt the undead will ever stop coming of their own accord.  How do we propose to stop them?")}
                [if]
                    {HAVE Eódia}
                    [then]
                        {SPEAK Eódia (_ "I can feel the corruption spreading through the forest.  Somewhere, there is some... vessel, some creature or object, which is the source of that corruption.")}
                        {SPEAK Eódia (_ "If we can locate and destroy that vessel, we can put an end to the corruption of the woses.  Some corrupted woses may even be restored.")}
                        {SPEAK Eódia (_ "To stop the undead attacks, though, I fear we must locate and destroy their master.  I sense an ominous presence in the east, but cannot say where.")}
                    [/then]
                    [else]
                        {SPEAK (Demla Ka) (_ "As you once said, we have to strike at their source.")}
                        {SPEAK (Demla Ka) (_ "These attacking undead seem mindless.  Somewhere, they must have a leader, and the corruption in the forest must also be spreading from some point.")}
                    [/else]
                [/if]
                [objectives]
                    side=1
                    {VICTORY_CONDITION (_ "Find and destroy the source of the corruption")}
                    {VICTORY_CONDITION (_ "Find and destroy the leader of the undead")}
                    {DONT_LOSE_HEROES}
                [/objectives]
            [/then]
        [/if]
    [/event]

    [event]
        name=turn 11
        [if]
            {HAVE (Leódir)}
            {HAVE (Eódia)}
            [then]
                {SPEAK Eódia (_ "Their power grows again.  Seek out and strike at the heart of their corruption!")}
                {SPEAK (Demla Ka) (_ "How can you sense the change in their power?")}
                {SPEAK Eódia (_ "I am one with the heart of the forest.  I sense its suffering, the evil eating away at it...")}
                {SPEAK Varnir (_ "Either that, or she's noticed a pattern and can tell time.")}  ## He doesn't like her, does he?
            [/then]
        [/if]
    [/event]

    [event]
#ifdef HARD
        name=turn 29
#endif
#ifdef NORMAL
        name=turn 35
#endif
#ifdef EASY
        name=turn 35
#endif

        [if]
            {HAVE (Leódir)}
            [then]
                [if]
                    {HAVE (Eódia)}
                    [then]
                        {SPEAK Eódia (_ "Oh!  The corruption in the forest grows so strong... I fear it will not be long before every tree turns against us...")}
                    [/then]
                    [else]
                        {ELF_SHAMAN_SAYS (_ "I have a horrible feeling about what's happening in the forest.  If we don't stop the corruption soon, I fear every tree will turn against us.")}
                    [/else]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
#ifdef HARD
        name=turn 35
#endif
#ifdef NORMAL
        name=turn 41
#endif
#ifdef EASY
        name=turn 41
#endif
        [if]
            [not]
                {HAVE (Leódir)}
            [/not]
            [then]
                [if]
                    {HAVE (Eódia)}
                    [then]
                        {SPEAK Eódia (_ "Hurry, Feralon!  Even with Leódir laid to rest, there is a spreading evil in the heart of the forest.  Strike down the lich while it can still be stopped!")}
                    [/then]
                    [else]
                        {ELF_SHAMAN_SAYS (_ "I have a horrible feeling that even with Leódir laid to rest, the forest is soon to be overtaken by darkness.  We must strike down the lich!")}
                    [/else]
                [/if]
            [/then]
        [/if]
    [/event]
    [event]
        name=sighted
        [filter]
            description=Leódir
        [/filter]
        [filter_second]
            side=1,2
        [/filter_second]
        {HIGHLIGHT_UNIT (description=Leódir)}
        {SPEAK second_unit (_ "What is that thing?  I can see violet energy radiating from it into the forest and the corrupted woses.")}
        [if]
            {HAVE Eódia}
            [then]
                {SPEAK Eódia (_ "I feared this.  Oh, Leódir, what have they done to you?")}
                [if]
                    {HAVE Torr}
                    [then]
                        {SPEAK Torr (_ "What, that thing is a friend of yours?")}
                        {ELF_SHAMAN_SAYS (_ "Show some respect!  Leódir was a great leader of our people, before he died fighting orcs many years ago.")}
                    [/then]
                [/if]
            [/then]
        [/if]
        {SPEAK (Demla Ka) (_ "I think we can safely assume that this haunt is the source of the corruption.")}
        [if]
            {HAVE Eódia}
            [then]
                {SPEAK Eódia (_ "Yes, he must be laid to rest.  But he is not commanding the undead... that baleful presence lies elsewhere.")}
            [/then]
            [else]
                [if]
                    {HAVE_SHAMAN}
                    [then]
                        {ELF_SHAMAN_SAYS (_ "That tortured face... I think he is Leódir, once a great leader of our people.  We must lay him to rest... but I fear some greater evil directs him.")}
                    [/then]
                    [else]
                        {SPEAK Varnir (_ "Yes, but is he the leader of the undead as well?")}
                    [/else]
                [/if]
            [/else]
        [/if]
        {VARIABLE leodir_sighted yes}
        [objectives]
            side=1
            {VICTORY_CONDITION (_ "Lay Leódir to rest")}
            {VICTORY_CONDITION (_ "Find and destroy the leader of the undead")}
            {DONT_LOSE_HEROES}
        [/objectives]
    [/event]

    [event]
        name=sighted
        [filter]
            type=Walking Corpse,Soulless
            variation=drake
        [/filter]
        [filter_second]
            side=1,2
        [/filter_second]
        {SPEAK Feralon (_ "That looks like it was once a drake!  How is that possible?")}
        [if]
            {HAVE Eódia}
            [then]
                {SPEAK Eódia (_ "Many a drake has fought and died in this forest over the centuries.")}
            [/then]
            [else]
                {SPEAK Varnir (_ "We left fallen comrades behind when we raided this forest.  Doubtless others have fallen here over the years.")}
            [/else]
        [/if]
        [if]
            {HAVE Celondë}
            [then]
                {SPEAK Celondë (_ "And for what?  I will never understand why your kind seeks out pointless battle.")}
                {SPEAK Feralon (_ "So that we can be prepared when a day like today comes.")}
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            [not]
                x=0-18
                y=23-40
            [/not]
            description=Móndir
        [/filter]
        {SPEAK Laviniel (_ "Móndir, what are you thinking?  Don't go out there!")}
        {SPEAK Móndir (_ "The corruption must be opposed!")}
        [if]
            {HAVE Celondë}
            {HAVE Laviniel}
            [then]
                {SPEAK Celondë (_ "Lavi, didn't you have something you wanted to tell Móndir?  Now might be a good time.")}
                {SPEAK Laviniel (_ "Hush!  Can't you see he's busy?  Oh, I hope he will be all right...")}
            [/then]
        [/if]
    [/event]

    [event]
        {ON_ATTACK Móndir}
        {SPEAK Móndir (_ "Our forest will be freed of your corruption!")}
    [/event]

    [event]
        {ON_DEATH Móndir}
        [if]
            {HAVE Laviniel}
            [then]
                {SPEAK Laviniel (_ "Móndir!  No!  I never told him how I really felt...")}
                {SPEAK Celondë (_ "I think he knew, Lavi.")}
            [/then]
            [else]
                {SPEAK Eódia (_ "So passes a great champion of the forest.  You will be missed, Móndir.")}
            [/else]
        [/if]
        {VARIABLE mondir_alive no}
    [/event]

    [event]
        {ON_ATTACK Eódia}
        {SPEAK Eódia (_ "Back, creature of corruption!  Our citadel will not fall while I live!")}
    [/event]

    [event]
        {ON_ATTACKED Eódia}
        {ELF_SHAMAN_SAYS (_ "They are attacking our Lady!  Feralon, we have to help her!")}
    [/event]

    [event]
        {ON_LAST_BREATH Eódia}
        [if]
            {HAVE Móndir}
            [then]
                {SPEAK Eódia (_ "Móndir, I fear you must lead our people now...")}
                {SPEAK Móndir (_ "My Lady... I doubt I can shoulder this burden... but I will try...")}
            [/then]
        [/if]
        {SPEAK Eódia (_ "Fight on, Feralon... the forest... must be free...")}
    [/event]

    [event]
        {ON_DEATH Eódia}
        {MODIFY_UNIT description=Móndir canrecruit yes}
        {SPEAK Celondë (_ "She is gone... how can this be?  I remember her laughter... I shall never laugh again.")}
        {SPEAK Laviniel (_ "Death comes to us all... Somehow, I always thought she was exempt.")}
        {SPEAK (Demla Ka) (_ "What a sad loss.  I wish I could have known her better.")}
        {SPEAK Feralon (_ "We must see to it that she is avenged.")}
        {VARIABLE eodia_alive no}
    [/event]

    [event]
        {ON_LAST_BREATH Laviniel}
        {SPEAK Laviniel (_ "I knew... I wouldn't make it through this...")}
    [/event]

    [event]
        {ON_LAST_BREATH Celondë}
        {SPEAK Celondë (_ "Feralon... don't let me die in vain...")}
    [/event]

    [event]
        {ON_DEATH Laviniel}
        {SPEAK Celondë (_ "No, Laviniel!  Please don't die!")}
        {SPEAK (Demla Ka) (_ "Alas!  I will grieve for you, Laviniel, when there is time.")}
        {SPEAK Móndir (_ "And she never knew how I felt about her...")}
        {SPEAK Eódia (_ "We will all miss her.  We must fight on, so that she can live in our memories.")}
        [if]
            [not]
                {HAVE Celondë}
            [/not]
            [then]
                {CLEAR_DUMMY_AMLA (Demla Ka) enable_heal}  ## Random elves aren't going to teach it to her
                {CLEAR_DUMMY_AMLA Varnir enable_forest}
            [/then]
        [/if]
    [/event]

    [event]
        {ON_DEATH Celondë}
        {SPEAK Laviniel (_ "No, Celondë!  Tell me this isn't happening!")}
        {SPEAK Eódia (_ "I had thought that one day... she might take my place.  I never thought to outlive her.")}
        {SPEAK Feralon (_ "Who knew that a tiny elf could be so brave?  I will fight now in her name.")}
        [if]
            [not]
                {HAVE Laviniel}
            [/not]
            [then]
                {CLEAR_DUMMY_AMLA (Demla Ka) enable_heal}  ## Random elves aren't going to teach it to her
                {CLEAR_DUMMY_AMLA Varnir enable_forest}
            [/then]
        [/if]
    [/event]

    [event]
        {ON_MOVE_TO (43,44,45,46,47,48,49) (16-19,15-19,15-20,14-20,15-20,15-19,16-19) side=1}
        [allow_undo]
        [/allow_undo]
        [if]
            [not]
                {HAVE Mal-Taryn}  ## Don't trigger event if vines have already been removed
            [/not]
            [then]
                {SPEAK unit (_ "The way is blocked by a mass of entangled vines.  They look dead but resist all attempts to cut or burn them.")}
            [/then]
        [/if]
    [/event]

    [event]
        name=die
        [filter]
            side=3
            canrecruit=yes
        [/filter]
        [if]
            [not]
                {HAVE Mal-Taryn}
            [/not]
            [then]
                {SPEAK second_unit (_ "Could that have been the leader of the undead?")}
                [if]
                    {HAVE Eódia}
                    [then]
                        {SPEAK Eódia (_ "No, merely a nearly-mindless servitor.  But laying it to rest may have slowed the undead assault.")}
                    [/then]
                    [else]
                        {SPEAK (Demla Ka) (_ "I doubt it... It seemed more like another servant.  I hope that slaying it will at least slow the enemy assault.")}
                    [/else]
                [/if]
            [/then]
        [/if]
        {VARIABLE_OP side4_boost add 12}
        {VARIABLE_OP side5_boost add 15}
    [/event]

    [event]
        name=die
        [filter]
            side=4
            canrecruit=yes
        [/filter]
        [if]
            [not]
                {HAVE Mal-Taryn}
            [/not]
            [then]
                {SPEAK second_unit (_ "Could this knight have been the leader of the undead?")}
                {SPEAK Varnir (_ "No, it seemed of the same ilk as the captains of the legions that attacked us.")}
                {SPEAK Eódia (_ "Indeed, another nearly-mindless servitor.  Still, depriving our enemy of its captains is worthwhile.")}
            [/then]
        [/if]
        {VARIABLE_OP side3_boost add 12}
        {VARIABLE_OP side5_boost add 25}
    [/event]

    [event]
        {ON_LAST_BREATH (Leódir)}
        {SPEAK (Leódir) (_ "Ah, to rest.... forgive me, Eódia, for all that I have done...")}
    [/event]

    [event]
        {ON_DEATH (Leódir)}
        [if]
            {HAVE Eódia}
            [then]
                {SPEAK Eódia (_ "Of course I forgive you, my love.  How could you imagine I would not?  Sleep now.")}
            [/then]
            [else]
                {ELF_SHAMAN_SAYS (_ "You and she are joined in death now, Leódir.  I know she would forgive you.")}
            [/else]
        [/if]

        ## Most corrupted elder and ancient woses are too corrupted to survive
        {FLASH_GREEN ()}
        [kill]
            side=5
            type=Corrupted Elder Wose, Corrupted Ancient Wose
            animate=yes
        [/kill]

        ## Change all corrupted woses back into normal woses and change them to side 7
        [store_unit]
            [filter]
                side=5
                type=Corrupted Wose
            [/filter]

            variable=woses_store
            kill=yes
        [/store_unit]

        [modify_side]
            side=7
            {GOLD 120 80 40}
            {INCOME 12 8 4}
        [/modify_side]

        {FOREACH woses_store i}  ## Switch this to use TRANSFORM_UNIT in 1.5,1.6?
            [unit]
                type=Wose
                side=7
                description=$woses_store[$i].description
                user_description=$woses_store[$i].user_description
                hitpoints=$woses_store[$i].hitpoints
                experience=$woses_store[$i].experience
                x=$woses_store[$i].x
                y=$woses_store[$i].y
                facing=$woses_store[$i].facing
            [/unit]
            {GIVE_GOLD 7 -10}  ## Still a 50% discount
        {NEXT i}

        {CLEAR_VARIABLE woses_store}

        [unit]
            side=7
            type=Ancient Wose
            canrecruit=yes
            description=Temtundembun
            user_description=_ "Temtundembun"
            gender=male
            x,y=31,10
        [/unit]
        
        {VARIABLE wose_leader_alive yes}

        {SPEAK Temtundembun (_ "It is as if we have awakened from a deep sleep, troubled by memories of an unhappy dream.  We have done wrong.  What can we do to remedy these wrongs?")}
        [if]
            {HAVE Eódia}
            [then]
                {SPEAK Eódia (_ "Join us in striking down the evil in this forest!")}
            [/then]
            [else]
                [if]
                    {HAVE_SHAMAN}
                    [then]
                        {ELF_SHAMAN_SAYS (_ "Join us in striking down the evil in this forest!")}
                    [/then]
                    [else]
                        {SPEAK Feralon (_ "Join us in avenging the elves against the evil in this forest!")}
                    [/else]
                [/if]
            [/else]
        [/if]
        {SPEAK Temtundembun (_ "We gladly join you in this struggle.")}

        ## Remove the void/vines over the last keep and create it and its occupants
        {MODIFY_TERRAIN Rd (44,44) (17,18)}
        {MODIFY_TERRAIN Gs^Fp (44,45,46,45,46,47) (16,16,15,19,19,19)}
        {MODIFY_TERRAIN Hh (47,48,48,48) (16,16,17,18)}
        {MODIFY_TERRAIN Cud (45,45,46,46,47,47) (17,18,16,18,17,18)}
        {MODIFY_TERRAIN Kud 46 17}
        [unit]
            side=6
            x,y=46,17
#ifndef HARD
            type=Lich
#else
            type=Ancient Lich
#endif
            description=Mal-Taryn
            user_description= _ "Mal-Taryn"
            gender=female
            canrecruit=yes
        [/unit]
        [modify_side]
            side=6
            {GOLD 120 200 300}
            {INCOME 20 35 50}
        [/modify_side]
        {GENERIC_UNIT 6 Revenant 45 17}
        {GENERIC_UNIT 6 Revenant 45 18}
        {GENERIC_UNIT 6 (Bone Shooter) 46 16}
        {GENERIC_UNIT 6 (Bone Shooter) 46 18}
#ifndef EASY
        {GENERIC_UNIT 6 (Bone Shooter) 47 17}
        {GENERIC_UNIT 6 Wraith 47 18}
#endif
        {CLEAR_FOG 1 44 17 4}
        {THUNDER ()}
        {SPEAK Mal-Taryn (_ "How DARE you destroy my pet?  I will have to create another... perhaps in the corpse of yonder elven queen.")}
        {SPEAK Eódia (_ "What manner of horror are you?  Why have you desecrated our forest?")}
        {SPEAK Feralon (_ "Why did you attack my people?")}
        {SPEAK Mal-Taryn (_ "I do not answer to the likes of you.  Slay them, my minions!  Let nothing that breathes remain in these woods!")}
        {UNCLEAR_FOG}
        [modify_turns]
            add=6
        [/modify_turns]
        [objectives]
            side=1
            {VICTORY_CONDITION (_ "Destroy the lich, Mal-Taryn")}
            {DONT_LOSE_HEROES}
        [/objectives]
    [/event]
    
    [event]
        {ON_LAST_BREATH Temtundembun}
        {SPEAK Temtundembun (_ "And so... I make... my amends")}
    [/event]
    
    [event]
        {ON_DEATH Temtundembun}
        {VARIABLE wose_leader_alive no}
        {SPEAK Eódia (_ "Rest peacefully, great wose.  The forest forgives you.")}
    [/event]

    [event]
        {ON_LAST_BREATH (Mal-Taryn)}  ## So to speak.
        {SPEAK Mal-Taryn (_ "I can scarcely believe such a thing possible.  Defeated... by you weaklings?")}
        [if]
            {VAR_EQUALS second_unit.race drake}
            [then]
                {SPEAK second_unit (_ "You shall never threaten us again!")}
                {SPEAK Mal-Taryn (_ "Poor deluded fool.  Your people are doomed already.")}
            [/then]
            [else]
                [if]
                    {VAR_EQUALS second_unit.race elf}
                    [then]
                        {SPEAK second_unit (_ "Our forest is purified of your taint!")}
                        {SPEAK Mal-Taryn (_ "Poor deluded fool.  Your forest was never our goal... in my destruction lies your defeat...")}
                    [/then]
                    [else]
                        {SPEAK second_unit (_ "No longer shall your kind threaten the drakes and elves!")}
                        {SPEAK Mal-Taryn (_ "Poor deluded fool.  The drakes are doomed already.")}
                    [/else]
                [/if]
            [/else]
        [/if]
    [/event]

    [event]
        {ON_DEATH (Mal-Taryn)}
        {END_LEVEL victory}
    [/event]

    ##|| Victory and Defeat
    {HERO_DEATHS}

    [event]
        name=time over
        [if]
            {HAVE Eódia}
            [then]
                {SPEAK Feralon (_ "Undead are bursting from every corner of the forest!")}
                {SPEAK Eódia (_ "They have grown too strong.  The forest is lost to us.")}
            [/then]
            [else]
                {SPEAK Feralon (_ "Undead are bursting from every corner of the forest!  We are lost!")}
            [/else]
        [/if]
        {END_LEVEL defeat}
    [/event]

    [event]
        name=victory
        {KILL_SIDE 3,4,5,6}
        {SPEAK (Demla Ka) (_ "What could she have meant?")}
        {SPEAK (Feralon) (_ "The bag of bones most likely sought only to rob us of the joy of victory.  I'm sure she was lying.")}
        {SPEAK narrator (_ "But she was not.")}
        {SPEAK narrator (_ "This is the end of Part I of 'On Crimson Wings.'  If you save your game now, you can load it to continue on to Part II when it is released.")}
        ## Obviously, remove that last line when more scenarios written

        [if]
            {VAR_EQUALS eodia_alive yes}
            [then]
                [store_unit]
                    [filter]
                        description=Eódia
                    [/filter]
                    variable=eodia_store
                    kill=no
                [/store_unit]
            [/then]
        [/if]

        [if]
            {VAR_EQUALS mondir_alive yes}
            [then]
                [store_unit]
                    [filter]
                        description=Móndir
                    [/filter]
                    variable=mondir_store
                    kill=no
                [/store_unit]
            [/then]
        [/if]
        
        [if]
            {VAR_EQUALS wose_leader_alive yes}
            [then]
                [store_unit]
                    [filter]
                        description=Temtundembun
                    [/filter]
                    variable=wose_leader_store
                    kill=no
                [/store_unit]
            [/then]
        [/if]

        {CLEAR_VARIABLE wose_side}
        {CLEAR_VARIABLE side3_boost}
        {CLEAR_VARIABLE side4_boost}
        {CLEAR_VARIABLE side5_boost}
        {CLEAR_VARIABLE leodir_sighted}
    [/event]
[/scenario]
